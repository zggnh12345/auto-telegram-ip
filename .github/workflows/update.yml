name: Update Telegram IP Routes (IPv4 & IPv6)

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 2-31 * *'    # å¸¸è§„æ›´æ–°ï¼ˆ2-31å· UTC 0:00ï¼‰
    - cron: '0 0 1 * *'       # å¼ºåˆ¶æ›´æ–°ï¼ˆ1å· UTC 0:00ï¼Œä»“åº“ä¿æ´»ï¼‰
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ¤æ–­æ›´æ–°æ¨¡å¼
        id: mode
        run: |
          UTC_DAY="$(date -u +%d)"
          echo "utc_day=${UTC_DAY}" >> $GITHUB_OUTPUT

          # ä»…å½“ schedule è§¦å‘ä¸”ä¸º 1 å·æ—¶å¯ç”¨æœˆåº¦å¼ºåˆ¶æ¨¡å¼
          if [ "${GITHUB_EVENT_NAME}" = "schedule" ] && [ "${UTC_DAY}" = "01" ]; then
            echo "is_monthly_forced=true" >> $GITHUB_OUTPUT
            echo "::notice::ğŸ—“ï¸ æœˆåº¦å¼ºåˆ¶æ›´æ–°æ¨¡å¼ï¼ˆä»“åº“ä¿æ´»ï¼‰"
          else
            echo "is_monthly_forced=false" >> $GITHUB_OUTPUT
            echo "::notice::ğŸ“… å¸¸è§„æ›´æ–°æ¨¡å¼"
          fi

      - name: ç”Ÿæˆè·¯ç”±æ–‡ä»¶
        id: gen
        run: |
          set -euo pipefail

          # éªŒè¯è„šæœ¬å­˜åœ¨
          if [ ! -f "./generate-telegram-routes.sh" ]; then
            echo "::error::è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          fi
          chmod +x ./generate-telegram-routes.sh

          # æœˆåº¦å¼ºåˆ¶æ¨¡å¼ï¼šå…ˆåˆ é™¤æ—§æ–‡ä»¶
          if [ "${{ steps.mode.outputs.is_monthly_forced }}" = "true" ]; then
            echo "::notice::ğŸ”„ åˆ é™¤æ—§æ–‡ä»¶ä»¥å¼ºåˆ¶é‡æ–°ç”Ÿæˆ"
            rm -f routeros-telegram-routes.rsc routeros-telegram-addresslist.rsc
          fi

          # æ‰§è¡Œç”Ÿæˆè„šæœ¬
          echo "::notice::ğŸ”§ å¼€å§‹ç”Ÿæˆè·¯ç”±æ–‡ä»¶"
          ./generate-telegram-routes.sh

          # éªŒè¯ç”Ÿæˆç»“æœ
          if [ ! -f "routeros-telegram-routes.rsc" ] || [ ! -s "routeros-telegram-routes.rsc" ]; then
            echo "::error::è·¯ç”±æ–‡ä»¶ç”Ÿæˆå¤±è´¥æˆ–ä¸ºç©º"
            exit 1
          fi
          if [ ! -f "routeros-telegram-addresslist.rsc" ] || [ ! -s "routeros-telegram-addresslist.rsc" ]; then
            echo "::error::åœ°å€åˆ—è¡¨æ–‡ä»¶ç”Ÿæˆå¤±è´¥æˆ–ä¸ºç©º"
            exit 1
          fi

          # ç»Ÿè®¡å¹¶è¾“å‡º
          ROUTE_COUNT=$(grep -c 'add comment=' routeros-telegram-routes.rsc || echo 0)
          ADDR_COUNT=$(grep -c 'add list=' routeros-telegram-addresslist.rsc || echo 0)
          echo "route_count=${ROUTE_COUNT}" >> $GITHUB_OUTPUT
          echo "addr_count=${ADDR_COUNT}" >> $GITHUB_OUTPUT
          echo "::notice::âœ… ç”Ÿæˆå®Œæˆ | è·¯ç”±: ${ROUTE_COUNT} | åœ°å€åˆ—è¡¨: ${ADDR_COUNT}"

      - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: changes
        if: steps.mode.outputs.is_monthly_forced != 'true'
        run: |
          # ä»…åœ¨å¸¸è§„æ¨¡å¼ä¸‹æ£€æŸ¥å˜æ›´
          if [ -n "$(git status --porcelain routeros-telegram-routes.rsc routeros-telegram-addresslist.rsc)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "::notice::âœ… æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "::notice::â„¹ï¸ æ–‡ä»¶æ— å˜æ›´"
          fi

      - name: æäº¤å¹¶æ¨é€
        if: steps.mode.outputs.is_monthly_forced == 'true' || steps.changes.outputs.has_changes == 'true'
        run: |
          set -euo pipefail
          
          # é…ç½® Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ä½¿ç”¨ git add -A å¤„ç†æ‰€æœ‰å˜æ›´ï¼ˆæ–°å¢/ä¿®æ”¹/åˆ é™¤ï¼‰
          git add -A routeros-telegram-routes.rsc routeros-telegram-addresslist.rsc
          
          # ä»å‰ä¸€æ­¥éª¤è·å–ç»Ÿè®¡æ•°æ®ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
          ROUTE_COUNT=${{ steps.gen.outputs.route_count }}
          ADDR_COUNT=${{ steps.gen.outputs.addr_count }}
          COMMIT_DATE="$(date -u +%Y-%m-%d)"

          if [ "${{ steps.mode.outputs.is_monthly_forced }}" = "true" ]; then
            # æœˆåº¦å¼ºåˆ¶æ¨¡å¼ï¼šä½¿ç”¨ --allow-empty ä¿è¯æäº¤
            git commit --allow-empty -m "chore: æœˆåº¦å¼ºåˆ¶æ›´æ–°ï¼ˆä»“åº“ä¿æ´»ï¼‰[${COMMIT_DATE}]

- è·¯ç”±æ¡ç›®: ${ROUTE_COUNT}
- åœ°å€åˆ—è¡¨: ${ADDR_COUNT}
- å¼ºåˆ¶æäº¤ä»¥ä¿æŒä»“åº“æ´»è·ƒ"
            
            echo "::notice::ğŸš€ æœˆåº¦ä¿æ´»æäº¤å·²åˆ›å»º"
          else
            # å¸¸è§„æ¨¡å¼ï¼šæœ‰å˜æ›´æ‰æäº¤
            if git diff --cached --quiet; then
              echo "::notice::â„¹ï¸ æ— å˜æ›´éœ€è¦æäº¤"
              exit 0
            fi
            
            git commit -m "chore: æ›´æ–° Telegram IP è·¯ç”± [${COMMIT_DATE}]

- è·¯ç”±æ¡ç›®: ${ROUTE_COUNT}
- åœ°å€åˆ—è¡¨: ${ADDR_COUNT}"
            
            echo "::notice::âœ… å˜æ›´å·²æäº¤"
          fi
          
          # æ¨é€åˆ°ä¸»åˆ†æ”¯
          git push origin HEAD:main
          echo "::notice::ğŸ“¤ æ¨é€å®Œæˆ"

      - name: éªŒè¯ç»“æœ
        if: always()
        run: |
          echo "::group::ğŸ“‹ ä»“åº“çŠ¶æ€"
          git status --short --branch
          echo "::endgroup::"
          
          echo "::group::ğŸ“ æœ€æ–°æäº¤"
          git --no-pager log -1 --oneline --stat
          echo "::endgroup::"
          
          if [ -f "routeros-telegram-routes.rsc" ] && [ -f "routeros-telegram-addresslist.rsc" ]; then
            ROUTE_COUNT=$(grep -c 'add comment=' routeros-telegram-routes.rsc || echo 0)
            ADDR_COUNT=$(grep -c 'add list=' routeros-telegram-addresslist.rsc || echo 0)
            echo "::notice::âœ… æ–‡ä»¶éªŒè¯é€šè¿‡ | è·¯ç”±: ${ROUTE_COUNT} | åœ°å€åˆ—è¡¨: ${ADDR_COUNT}"
          else
            echo "::error::âŒ æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
