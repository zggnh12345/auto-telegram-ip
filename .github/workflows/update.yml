name: Update Telegram IP Routes (IPv4 & IPv6)

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤© UTC æ—¶é—´ 1:00 è¿è¡Œ
    - cron: '0 0 1 * *'  # æ¯æœˆ1å· UTC æ—¶é—´ 0:00 è¿è¡Œï¼ˆå¼ºåˆ¶æ›´æ–°ï¼‰
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Generate Route Script
      run: |
        chmod +x ./generate-telegram-routes.sh
        ./generate-telegram-routes.sh

    - name: Commit and Push Updated RSC Files
      run: |
        set -euo pipefail

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # æš‚å­˜ç›®æ ‡æ–‡ä»¶ï¼ˆè‹¥ä¸å­˜åœ¨ä¹Ÿä¸ä¼šä¸­æ–­ï¼‰
        git add routeros-telegram-routes.rsc routeros-telegram-addresslist.rsc || true

        # è‹¥æ˜¯æ¯æœˆ1å·ï¼ˆUTCï¼‰ï¼Œåˆ™ä¿è¯æœ‰ä¸€æ¬¡æäº¤ï¼šå…ˆå°è¯•æ­£å¸¸æäº¤ï¼ˆè‹¥æœ‰å˜æ›´ï¼‰ï¼Œå¦åˆ™å¼ºåˆ¶ç©ºæäº¤ï¼›é1å·åˆ™åªåœ¨æœ‰å˜æ›´æ—¶æäº¤
        if [ "$(date -u +%d)" = "01" ]; then
          echo "Today is 1st of month (UTC): ensuring a commit (normal or --allow-empty)..."
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ¤– æ¯æœˆå¼ºåˆ¶æ›´æ–° Telegram IP è·¯ç”±å’Œåœ°å€åˆ—è¡¨ (files changed)"
          else
            git commit --allow-empty -m "ğŸ¤– æ¯æœˆä¿æ´»æäº¤ [keep-alive] $(date -u +%Y-%m-%d) [ci skip]"
          fi
          git push
          echo "Monthly forced update / keep-alive pushed."
        else
          # é 1 å·ï¼šä»…åœ¨æœ‰æ–‡ä»¶å˜æ›´æ—¶æäº¤å¹¶æ¨é€
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° Telegram IP è·¯ç”±å’Œåœ°å€åˆ—è¡¨"
            git push
            echo "Daily update with changes pushed."
          else
            echo "No changes in RSC files. Skipping commit."
          fi
        fi
