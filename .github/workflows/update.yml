name: Update Telegram IP Routes (IPv4 & IPv6)

on:
  schedule:
    - cron: '0 1 * * *'    # æ¯å¤© 01:00 UTC
    - cron: '0 1 1 * *'    # æ¯æœˆ 1 å· 01:00 UTCï¼ˆå¼ºåˆ¶æ›´æ–°ï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Route Script
        run: |
          chmod +x ./generate-telegram-routes.sh
          ./generate-telegram-routes.sh

      - name: Commit and Push Updated RSC Files (force regenerate on 1st)
        env:
          GIT_USER_NAME: "github-actions[bot]"
          GIT_USER_EMAIL: "github-actions[bot]@users.noreply.github.com"
          REPO_URL: "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
        run: |
          set -e

          git config user.name "${GIT_USER_NAME}"
          git config user.email "${GIT_USER_EMAIL}"

          # æ¯æœˆ1å·å¼ºåˆ¶ä¿®æ”¹æ–‡ä»¶ï¼Œè®©gitæ£€æµ‹ä¸ºå˜åŒ–
          if [ "$(date +'%d')" = "01" ]; then
            echo "Forcing refresh on 1st of month..."
            # æ”¹å˜æ–‡ä»¶æ—¶é—´æˆ³æˆ–é™„åŠ æ ‡è®°æ³¨é‡Š
            echo "# Forced monthly regeneration at $(date -u)" >> routeros-telegram-routes.rsc
            echo "# Forced monthly regeneration at $(date -u)" >> routeros-telegram-addresslist.rsc
          fi

          git add routeros-telegram-routes.rsc routeros-telegram-addresslist.rsc

          # æ£€æŸ¥æ˜¯å¦æœ‰æ”¹åŠ¨ï¼ˆåŒ…æ‹¬å¼ºåˆ¶æ”¹åŠ¨ï¼‰
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° Telegram IP è·¯ç”±å’Œåœ°å€åˆ—è¡¨ [CI]"
            git push "${REPO_URL}"
          else
            echo "No changes detected, skipping commit."
          fi
